name: Manual build frontend and push images

on:
  workflow_dispatch:
    inputs:
      registry:
        description: "Container registry (e.g., docker.io, ghcr.io)"
        required: true
        default: docker.io
        type: string
      namespace:
        description: "Registry namespace/org (e.g., your Docker Hub username or org)"
        required: true
        type: string
      tag:
        description: "Image tag to push (e.g., latest, v1.2.3)"
        required: true
        default: latest
        type: string

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build frontend
        working-directory: microservice/frontend
        run: |
          npm ci --no-audit --no-fund
          npm run build

  build-and-push:
    runs-on: ubuntu-latest
    needs: build-frontend
    strategy:
      fail-fast: false
      matrix:
        service: [auth-service, cache-service, core-service, gateway-service, utility-service]
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ${{ inputs.registry }}
      NAMESPACE: ${{ inputs.namespace }}
      TAG: ${{ inputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push images (${{ matrix.service }})
        uses: docker/build-push-action@v5
        with:
          context: .
          file: microservice/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/logstyx-${{ matrix.service }}:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/logstyx-${{ matrix.service }}:${{ github.sha }}

  release:
    name: Create or update GitHub Release
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: write
    env:
      REGISTRY: ${{ inputs.registry }}
      NAMESPACE: ${{ inputs.namespace }}
      TAG: ${{ inputs.tag }}
    steps:
      - name: Generate release notes
        run: |
          cat > RELEASE_BODY.md <<EOF
          Automated release for $TAG

          Images pushed:
          - $REGISTRY/$NAMESPACE/logstyx-auth-service:$TAG
          - $REGISTRY/$NAMESPACE/logstyx-cache-service:$TAG
          - $REGISTRY/$NAMESPACE/logstyx-core-service:$TAG
          - $REGISTRY/$NAMESPACE/logstyx-gateway-service:$TAG
          - $REGISTRY/$NAMESPACE/logstyx-utility-service:$TAG

          Commit: $GITHUB_SHA
          EOF
      - name: Create or update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ inputs.tag }}
          name: Release ${{ inputs.tag }}
          bodyFile: RELEASE_BODY.md
          allowUpdates: true
